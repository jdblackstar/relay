name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  quality:
    name: quality gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Test
        run: cargo test
      - name: Lint
        run: cargo clippy --all-targets --all-features -- -D warnings

  build-macos:
    name: macos ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
      - name: Package
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME}"
          target="${{ matrix.target }}"
          archive="relay_${version}_${target}.tar.gz"
          tar -C "target/${target}/release" -czf "${archive}" relay
          ARCHIVE="${archive}" python3 - <<'PY'
          import hashlib
          import os
          import pathlib

          archive = pathlib.Path(os.environ["ARCHIVE"])
          digest = hashlib.sha256(archive.read_bytes()).hexdigest()
          out = archive.with_name(archive.name + ".sha256")
          out.write_text(f"{digest}  {archive.name}\n")
          PY
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: |
            relay_${{ github.ref_name }}_${{ matrix.target }}.tar.gz
            relay_${{ github.ref_name }}_${{ matrix.target }}.tar.gz.sha256

  build-linux:
    name: linux ${{ matrix.target }}
    runs-on: ubuntu-latest
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-musl
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: taiki-e/install-action@v2
        with:
          tool: cross
      - name: Build
        run: cross build --release --target ${{ matrix.target }}
      - name: Package
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME}"
          target="${{ matrix.target }}"
          archive="relay_${version}_${target}.tar.gz"
          tar -C "target/${target}/release" -czf "${archive}" relay
          ARCHIVE="${archive}" python3 - <<'PY'
          import hashlib
          import os
          import pathlib

          archive = pathlib.Path(os.environ["ARCHIVE"])
          digest = hashlib.sha256(archive.read_bytes()).hexdigest()
          out = archive.with_name(archive.name + ".sha256")
          out.write_text(f"{digest}  {archive.name}\n")
          PY
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: |
            relay_${{ github.ref_name }}_${{ matrix.target }}.tar.gz
            relay_${{ github.ref_name }}_${{ matrix.target }}.tar.gz.sha256

  release:
    name: publish
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs:
      - build-macos
      - build-linux
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Extract raw changelog
        id: raw
        run: |
          python3 <<'PY'
          import os, re

          path = "CHANGELOG.md"
          out = os.environ["GITHUB_OUTPUT"]

          if not os.path.exists(path):
              with open(out, "a") as f:
                  f.write("body<<RELEASE_NOTES\nSee CHANGELOG.md for details.\nRELEASE_NOTES\n")
              raise SystemExit(0)

          with open(path) as f:
              content = f.read()

          m = re.search(r"## \[Unreleased\](.*?)(?=\n## \[|\Z)", content, re.DOTALL)
          body = m.group(1).strip() if m else "See CHANGELOG.md for details."

          with open(out, "a") as f:
              f.write("body<<RELEASE_NOTES\n")
              f.write(body)
              f.write("\nRELEASE_NOTES\n")
          PY

      # --- Agent-polished release notes (opt-in) ---
      # To enable: uncomment the two steps below, add ANTHROPIC_API_KEY to repo
      # secrets, and change the Publish step to use steps.polished.outputs.body
      # instead of steps.raw.outputs.body.
      #
      # - name: Install agent CLI
      #   run: npm install -g @anthropic-ai/claude-code
      #
      # - name: Polish release notes
      #   id: polished
      #   env:
      #     ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      #   run: |
      #     POLISHED=$(claude -p --model sonnet \
      #       "Rewrite these changelog bullets into concise, user-facing release notes in markdown. Keep ### section headings (Added, Changed, Fixed, etc). Do not invent changes. Output only the markdown, no preamble." \
      #       <<< "${{ steps.raw.outputs.body }}")
      #     {
      #       echo "body<<RELEASE_NOTES"
      #       echo "$POLISHED"
      #       echo "RELEASE_NOTES"
      #     } >> "$GITHUB_OUTPUT"

      - uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body: ${{ steps.raw.outputs.body }}
          files: dist/**/relay_*.tar.gz*

  changelog-cut:
    name: cut changelog for release
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Cut [Unreleased] to version and push
        run: |
          export TAG="${{ github.ref_name }}"
          export VERSION="${TAG#v}"
          export DATE=$(date -u +%Y-%m-%d)
          git fetch --tags
          PREV=$(git tag -l 'v*' --sort=-v:refname | sed -n '2p')
          export PREV=${PREV:-HEAD}

          python3 <<'PY'
          import os
          import re

          tag = os.environ["TAG"]
          version = os.environ["VERSION"]
          date = os.environ["DATE"]
          prev = os.environ["PREV"]

          path = "CHANGELOG.md"
          with open(path) as f:
              content = f.read()

          # Match [Unreleased] block up to next ## [
          unreleased_block = re.search(
              r"(## \[Unreleased\]\n\n)(.*?)(?=\n## \[|\Z)",
              content,
              re.DOTALL,
          )
          if not unreleased_block:
              raise SystemExit("CHANGELOG: no [Unreleased] block found")

          inner = unreleased_block.group(2)  # ### Added\n\n- ...
          new_section = f"## [{version}] - {date}\n\n{inner}\n\n## [Unreleased]\n\n### Added\n\n\n"
          content = content.replace(unreleased_block.group(0), new_section, 1)

          # Update [Unreleased] link
          content = re.sub(
              r"\[Unreleased\]: \S+",
              f"[Unreleased]: https://github.com/jdblackstar/relay/compare/{tag}...HEAD",
              content,
              count=1,
          )

          # Add new version link (before [Unreleased] link)
          content = re.sub(
              r"(\[Unreleased\]: https://[^\n]+\n)",
              f"[{version}]: https://github.com/jdblackstar/relay/compare/{prev}...{tag}\n\\1",
              content,
              count=1,
          )

          with open(path, "w") as f:
              f.write(content)
          PY

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          if git diff --staged --quiet; then
            echo "No changelog changes"
            exit 0
          fi
          git commit -m "chore: cut changelog for ${TAG}"
          git push origin main
