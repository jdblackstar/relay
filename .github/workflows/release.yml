name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  quality:
    name: quality gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Test
        run: cargo test
      - name: Lint
        run: cargo clippy --all-targets --all-features -- -D warnings

  build-macos:
    name: macos ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
      - name: Package
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME}"
          target="${{ matrix.target }}"
          archive="relay_${version}_${target}.tar.gz"
          tar -C "target/${target}/release" -czf "${archive}" relay
          ARCHIVE="${archive}" python3 - <<'PY'
          import hashlib
          import os
          import pathlib

          archive = pathlib.Path(os.environ["ARCHIVE"])
          digest = hashlib.sha256(archive.read_bytes()).hexdigest()
          out = archive.with_name(archive.name + ".sha256")
          out.write_text(f"{digest}  {archive.name}\n")
          PY
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: |
            relay_${{ github.ref_name }}_${{ matrix.target }}.tar.gz
            relay_${{ github.ref_name }}_${{ matrix.target }}.tar.gz.sha256

  build-linux:
    name: linux ${{ matrix.target }}
    runs-on: ubuntu-latest
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-musl
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: taiki-e/install-action@v2
        with:
          tool: cross
      - name: Build
        run: cross build --release --target ${{ matrix.target }}
      - name: Package
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME}"
          target="${{ matrix.target }}"
          archive="relay_${version}_${target}.tar.gz"
          tar -C "target/${target}/release" -czf "${archive}" relay
          ARCHIVE="${archive}" python3 - <<'PY'
          import hashlib
          import os
          import pathlib

          archive = pathlib.Path(os.environ["ARCHIVE"])
          digest = hashlib.sha256(archive.read_bytes()).hexdigest()
          out = archive.with_name(archive.name + ".sha256")
          out.write_text(f"{digest}  {archive.name}\n")
          PY
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: |
            relay_${{ github.ref_name }}_${{ matrix.target }}.tar.gz
            relay_${{ github.ref_name }}_${{ matrix.target }}.tar.gz.sha256

  release:
    name: publish
    runs-on: ubuntu-latest
    needs:
      - build-macos
      - build-linux
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/relay_*.tar.gz*
