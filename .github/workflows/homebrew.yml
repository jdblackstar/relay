name: homebrew

on:
  workflow_run:
    workflows: ["release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Existing release tag to bump (for example: v0.2.0)"
        required: true
        type: string

jobs:
  update-formula:
    name: update homebrew formula
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success' &&
       startsWith(github.event.workflow_run.head_branch, 'v') &&
       !contains(github.event.workflow_run.head_branch, '-'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Resolve tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "value=${{ inputs.tag_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download sha256 files
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          tag="${{ steps.tag.outputs.value }}"
          for target in aarch64-apple-darwin x86_64-unknown-linux-musl aarch64-unknown-linux-musl; do
            gh release download "$tag" \
              --repo jdblackstar/relay \
              --pattern "relay_${tag}_${target}.tar.gz.sha256"
          done

      - name: Read checksums
        id: sha
        run: |
          tag="${{ steps.tag.outputs.value }}"
          for target in aarch64-apple-darwin x86_64-unknown-linux-musl aarch64-unknown-linux-musl; do
            key=$(echo "$target" | tr '-' '_')
            hash=$(awk '{print $1}' "relay_${tag}_${target}.tar.gz.sha256")
            echo "${key}=${hash}" >> "$GITHUB_OUTPUT"
          done

      - name: Generate formula
        id: formula
        run: |
          tag="${{ steps.tag.outputs.value }}"
          version="${tag#v}"
          cat > relay.rb <<FORMULA
          class Relay < Formula
            desc "Sync commands, skills, and agents across AI coding tools"
            homepage "https://github.com/jdblackstar/relay"
            license "MIT"
            version "${version}"

            on_macos do
              on_arm do
                url "https://github.com/jdblackstar/relay/releases/download/${tag}/relay_${tag}_aarch64-apple-darwin.tar.gz"
                sha256 "${{ steps.sha.outputs.aarch64_apple_darwin }}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/jdblackstar/relay/releases/download/${tag}/relay_${tag}_x86_64-unknown-linux-musl.tar.gz"
                sha256 "${{ steps.sha.outputs.x86_64_unknown_linux_musl }}"
              end
              on_arm do
                url "https://github.com/jdblackstar/relay/releases/download/${tag}/relay_${tag}_aarch64-unknown-linux-musl.tar.gz"
                sha256 "${{ steps.sha.outputs.aarch64_unknown_linux_musl }}"
              end
            end

            def install
              bin.install "relay"
            end

            test do
              system bin/"relay", "--version"
            end
          end
          FORMULA

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' relay.rb

      - name: Push to homebrew-tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          tag="${{ steps.tag.outputs.value }}"
          version="${tag#v}"
          git clone "https://x-access-token:${GH_TOKEN}@github.com/jdblackstar/homebrew-tap.git" tap
          cp relay.rb tap/Formula/relay.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/relay.rb
          git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "relay ${version}"
          git push
